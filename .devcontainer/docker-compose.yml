# DevContainer Docker Compose Configuration
# This is SEPARATE from the main docker-compose.dev.yml
# Use this for VS Code/Cursor devcontainer development
# Use docker-compose.dev.yml for testing the full containerized app
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile

    volumes:
      # Mount the workspace
      - ..:/workspace:cached

      # DON'T mount .gitconfig - we'll configure Git in post-create.sh instead
      # This avoids "Device or resource busy" errors on Windows

      # Mount SSH keys for git operations (using root home since we run as root)
      - ~/.ssh:/root/.ssh:ro

      # Mount Docker socket for Docker-from-Docker (required for testing docker-compose.dev.yml)
      # Security: Provides full Docker host access to container (standard for DevContainers)
      # See .devcontainer/README.md "Security Model" section for details
      - /var/run/docker.sock:/var/run/docker.sock

      # Named volumes for better performance (using root paths)
      - vscode-extensions:/root/.vscode-server/extensions
      - vscode-extensions-insiders:/root/.vscode-server-insiders/extensions

    # Forward ports for development
    ports:
      - "5173:5173"  # Vite dev server (React)
      - "3001:3001"  # Express API server
      - "4404:4404"  # Virtual Node (testing)
      - "8080:8080"  # Docker deployment testing

    # Environment variables
    environment:
      - NODE_ENV=development
      - WORKSPACE_FOLDER=/workspace

    # Keep container running (entrypoint will handle user switching)
    # Using 'bash -c' to ensure entrypoint runs first
    command: /bin/bash -c "sleep infinity"

    # Network mode for accessing host services if needed
    network_mode: bridge

    # Add docker group to allow docker commands
    # Note: Running as root so docker access is automatic
    group_add:
      - docker

volumes:
  vscode-extensions:
  vscode-extensions-insiders:
